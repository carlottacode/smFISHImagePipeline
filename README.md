# smFISH Image Quantification Pipeline for Budding Yeast

## :green_heart: Aim :green_heart:
- The aim of this pipeline is to quantify smFISH images by detecting and counting mRNA spots in individual cells. 
- This pipeline begins to explore and facilitates  further investigation into localisation patterns of mRNA molecules within yeast cells. 

## :hourglass: Getting started...:hourglass:

#### :star2:Setting up a virtual conda environment:star2:

##### To set up a conda environment for this pipeline, run each of these lines in conda individually and sequentially.

<p>conda create -n smFISH_quantification python=3.9 -y<br>
conda activate smFISH_quantification<br>
pip install napari[all]<br>
pip install big-fish==0.6.2<br>
pip install stackview==0.6.3<br>
pip install scikit-image==0.21.0<br>
conda install -c anaconda opencv==4.6.0<br>
conda install -c conda-forge jupyterlab==3.5.0<br>
pip install shapely==2.0.1<br>
python -m pip install cellpose[gui]<br>
pip install openpyxl==3.1.2<br>
pip install xlsxwriter==3.1.2<br>
jupyter-notebook</p>

#### :computer:Running the notebook:computer:
- Make sure that any relevant user input has been changed (described in further detail below) as denoted in the second 'code' cell in the notebook. 
- Then simply run all cells (you can do this by going to Cell in the toolbar and then Run All). 
##### :smiley:Customising the pipeline:smiley:
- If you only wish to use one Cellpose model replace path strings assigned to the variables **pretrained_separate_model_path** and **pretrained_whole_SHIFTCORRECTED_model_path** with **None**. 
- If you wish to run a Cellpose model and after the shift has been corrected run with a more accurate Cellpose model only set the variable **pretrained_separate_model_path** equal to **None**. 
- If you wish to use your own pre-trained Cellpose model change the path string of **pretrained_whole_model_path** and set the other two Cellpose model path variables to **None** as shown in the notebook.

## :raised_hands: Steps within the Pipeline :raised_hands:
1. **Data**
	- This pipeline allows the user to input two '.tif' image file paths - a fluorescent image stack and a corresponding DIC image. 
	- The fluorescent image stack is split according to the channels specified. 
	- The dataset used to build and validate this pipeline was generated by Marah Jnied.
2.  **Maximum Intensity Projections**
	- For each of the channel image stacks, a Maximum Intensity Projection (MIP) is generated. These MIPs are used for all of the subsequent visualisation of the data. 
	- It will be possible to save the MIPs at the end of the pipeline. 
3. **Spot Detection**
	- Bigfish functions **detect_spots** and **decompose_dense** are used to detect spots in each of the channel z-stacks. 
	- The output of these functions is saved as a dictionary, where the key is the corresponding fluorescent channel.
4. **Segmentation**
	- To carry out the segmentation there are three pre-trained Cellpose models in this repository. 
	- The input for these Cellpose models is prepared within the notebook as part of the pipeline using the DIC image with the DAPI MIP. 
		- Two Cellpose models are used to initially generate two different masks:
			- "sep_model_1180": this model segments the buds and mothers as two different cells. 
			- "whole_model_993": this model segments the bud and the mother as one cell. 
		- This approach has been implemented to help identify and label the mother and bud cells as such for subsequent analysis. 
	- During the acquisition of the fluorescent image stack and the corresponding DIC image a shift is introduced. This shift (this is denoted as the "DIC shift" in this pipeline) must be corrected to allow for the accurate detection of mRNA spots per cell. 
	- The technical error of the shift between the DIC and the fluorescent channels is corrected by maximising the proportion of spots within cells. 
	- This information is used to improve on the segmentation by using the third pre-trained Cellpose model: "shifted_whole_model_993". 
5. **Spot per Cell Data Extraction**
	- The coordinates of the mRNA spots are combined with the "shifted" cell masks. 
	- mRNA per cell results are extracted using the Bigfish **extract_cell** function. 
6. **Analysis**
	- The number of mRNAs for each channel in each cell is calculated. 
	- Different localization metrics are calculated to identify mRNA localisation patterns, such as the polarization index and the dispersion index. 		- This has been done by using adapted versions of the bigfish functions **features_dispersion**, **features_distance** and **features_protrusion**.  

## :heavy_exclamation_mark: Output :heavy_exclamation_mark:
- The metrics calculated are then saved within an Excel file (user specified path). 
- The identification of bud and mother cells is included in the Excel file under "cell_type". 
- The metrics are calculated for each of the Cellpose models used with the resulting tables on different sheets of the Excel file ("whole_cells" and "mother_buds_separate") to allow further analysis.
 
## :fish: Required User Input :fish:
- The defaults mentioned below are used in the pipeline to analyse images generated by Marah Jnied.
- The fluorescence channels used during the aquisition of the images. 
	- DEFAULT = ['CY5', 'CY3', 'CY3.5', 'DAPI']
- Number of Z-slices per channel. 
	- DEFAULT = 41
- The colours of each fluoresence channel. 
	- DEFAULT = ['magenta', 'green', 'cyan', 'blue']
- The voxel size of the images (this can be found in the metadata of the acquired images). 
	- DEFAULT = (200, 64.5, 64.5))
-  The spot radius of the mRNA spots in the images. DEFAULT = (200, 70, 70)
-  Add the paths to the three Cellpose models downloaded from the repo:
	- pretrained_whole_model_path = ".../whole_model_993"
	- pretrained_separate_model_path = ".../sep_model_1180"
	- pretrained_whole_SHIFTCORRECTED_model_path = ".../shifted_whole_model_993"
- Add the path of the TIF and DIC file you'd like to analyse with this pipeline:
	- tif_path = '.../yET916-SUN4Q570-SRL1CFR610-ASH1CLB2Q670_03_CY5, CY3.5 NAR, CY3, DAPI.tif'
	- dic_path = ".../yET916-SUN4Q570-SRL1CFR610-ASH1CLB2Q670_04_DIC-100.tif"
- Add the path to which you'd like to save the analysis DataFrame:
	- results_excel_path = '.../smFISH_pipeline_outputs/output_yET916_BR2_03.xlsx'

