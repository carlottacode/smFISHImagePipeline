# smFISH Image Quantification Pipeline for Budding Yeast

# :green_heart: Aim :green_heart:
- The aim of this pipeline is to quantify smFISH images by detecting mRNA spots and assigning these to individual cells. 
- This allows further investigation into localisation patterns of different mRNAs within yeast cells. 

# :star2: Installation :star2:
## Setting up a virtual conda environment
<p>conda create -n smFISH_quantification python=3.9 -y<br>
conda activate carlotta_env<br>
pip install napari[all]<br>
pip install big-fish==0.6.2<br>
pip install stackview==0.6.3<br>
pip install scikit-image==0.21.0<br>
conda install -c anaconda opencv==4.6.0<br>
conda install -c conda-forge jupyterlab==3.5.0<br>
pip install shapely==2.0.1<br>
python -m pip install cellpose[gui]<br>
pip install openpyxl<br>
pip install xlsxwriter?<br>
jupyter-notebook</p>


# :raised_hands: Usage :raised_hands:

### Steps within the Pipeline:
#### Data
- This pipeline allows the user to input two .tif image file paths - a fluorescent image stack and a corresponding DIC image. 
- The fluorescent image stack is split according to the channels specified. 
- The dataset used to build this pipeline was generated by Marah Jnied.
#### Maximum Intensity Projections
- For each of the channel image stacks a Maximum Intensity Projection (MIP) is generated, these are used for all of the subsequent visualisation of the data. 
- The MIPs can be saved at the end of the pipeline. 

#### Spot Detection
- Bigfish functions **detect_spots** and **decompose_dense** are used to detect spots in each of the channel z-stacks. 
- The output of these functions is saved as a dictionary, where the key is the corresponding fluorescent channel.

#### Segmentation 
- For the segmentation there are three pre-trained Cellpose models in this repository. 
- The input for these Cellpose models is prepared using the DIC image with the DAPI maximum intensity projection. 
	- Two Cellpose models are used to initially generate two different masks:
		- "sep_model_1180" - This model segments the buds and mothers as different objects/cells. 
		- "whole_model_993" - This model segments the bud and the mother as one object/cell. 
	- This approach has been implemented to help identify and label the mother and bud cells for subsequent analysis. 
- During the acquisition of the fluorescent image stack and a corresponding DIC image there is a shift introduced, this shift (in this pipeline called the "DIC shift") must be corrected to allow for the accurate detection of mRNA spots per cell. 
- The technical error of the shift between the DIC and the fluorescent channels is corrected by calculating the proportion of spots within cells vs outside of them. 
- This information is used to improve on the segmentation. 

#### Spot per Cell Data Extraction
- The coordinates of the mRNA spots are combined with the "shifted" cell masks and per cell results are extracted using the Bigfish **extract_cell** function. 

#### Analysis
- The number of mRNAs for eeach channel in each cell is calculated. 
- Using the mRNA information per cell different indices can be calculated to measure mRNA localisation patterns, such as the polarization index and the dispersion index. This has been done using adapted versions of the bigfish function **features_dispersion**, **features_distance** and **features_protrusion**.  

#### Output 
- The metrics calculated are then saved within an excel file with the results calculated using the two different Cellpose models (separate and whole masks) on different sheets. 
- The labelling of mother and bud cells and each corresponding unit is also included in the Excel Spreadsheet. 

## Required User Input
- The fluorescence channels used for aquisition. 
	- (for the dataset used to build this pipeline this is ['CY5', 'CY3', 'CY3.5', 'DAPI'])
- Number of Z-slices per channel 
	- (for this pipeline the default is 41)
- The colours of each fluoresence channel
	- (the default for this pipeline is ['magenta', 'green', 'cyan', 'blue'])
- The voxel size of the images (this can be found in the metadata of the acquired images). 
	- (the default for this pipeline is  voxel_size=(200, 64.5, 64.5))
-  The spot radius of the mRNA spots in the images.  
	-  (for this pipeline the default is spot_radius=(200, 70, 70))
-  Please add the in the users filesystem the paths to the three Cellpose models downloaded from the repo:
	- pretrained_whole_model_path = ".../whole_model_993"
	- pretrained_separate_model_path = ".../sep_model_1180"
	- pretrained_whole_SHIFTCORRECTED_model_path = ".../shifted_whole_model_993"
- Please add the path of the TIF and DIC file you'd like to analyse with this pipeline
	- tif_path = '.../yET916-SUN4Q570-SRL1CFR610-ASH1CLB2Q670_03_CY5, CY3.5 NAR, CY3, DAPI.tif'
	- dic_path = ".../yET916-SUN4Q570-SRL1CFR610-ASH1CLB2Q670_04_DIC-100.tif"
- Please add the path to which you'd like to save the DataFrame containing the metrics calculates
	- results_excel_path  '.../smFISH_pipeline_outputs/output_yET916_BR2_03.xlsx'

